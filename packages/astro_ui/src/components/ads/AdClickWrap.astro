---
import type { TrackingComponent } from "@/sage/types/Tracking";

interface Props extends TrackingComponent {}

const props = Astro.props;
---

<script>
  import { SageLibrary } from "@/sage/SageLibrary.ts";

  class AdClickWrap extends HTMLElement {
    otid: string;
    page: string;
    placement: string;
    sageURL: string;
    trackingValues: {};
    inWindow = false;
    iframeClick = () => {
      if (this.inWindow) {
        const extraParams = {
          [SageLibrary.PARAM_PAGE]: this.page,
          [SageLibrary.PARAM_PLACEMENT]: this.placement,
        };

        SageLibrary.callOfferTemplateClick(
          this.trackingValues,
          this.otid,
          extraParams,
        );
      }
    };

    constructor() {
      super();

      // Read the message from the data attribute.
      this.otid = this.dataset.otid ? this.dataset.otid : "";
      this.page = this.dataset.page ? this.dataset.page : "";
      this.placement = this.dataset.placement ? this.dataset.placement : "";
      this.sageURL = this.dataset.sageUrl ? this.dataset.sageUrl : "";
      this.trackingValues = this.dataset.trackingValues
        ? JSON.parse(this.dataset.trackingValues)
        : {};
      this.onmouseenter = () => {
        this.inWindow = true;
      };

      this.onmouseleave = () => {
        this.inWindow = false;
      };

      window.addEventListener("blur", this.iframeClick);
    }
  }

  customElements.define("ad-click-wrap", AdClickWrap);
</script>
<ad-click-wrap
  data-otid={props.otID}
  data-page={props.page}
  data-placement={props.placement}
  data-sage-url={props.sageURL}
  data-tracking-values={JSON.stringify(props.trackingValues)}
>
  <slot />
</ad-click-wrap>
